<!DOCTYPE html>
<html>
<head>
	<title>NES Tile Viewer</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="js/paintTile.js"></script>

	<script src="js/jquery-3.5.1.slim.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

</head>
<body style="padding: 20px; background: #c7c7c7;">

	<div class="container"><div class="row">

		<div style="position: fixed; width: 300px">

			<h2 style="padding-bottom: 5px">
				<!-- <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/40/NES-Cartridge.jpg/250px-NES-Cartridge.jpg" style="width: 50px;"> -->
				NES Tile Viewer
			</h2>

			<div class="card">
				<div class="card-header">File (*.chr, *.nes, ...)</div>
				<div class="card-body">

					<input type="file" id="fileSelector" style="width: 100%">
				</div>
			</div>

			<div class="card" style="margin-top: 20px">
				<div class="card-header">Color Palette</div>
				<div class="card-body">

					<table><tr>
						<td><button type="button" class="btn btn-light" onclick="shiftColor(1)">◄</button></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker1" onchange="onColorClicked(1)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker2" onchange="onColorClicked(2)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker3" onchange="onColorClicked(3)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker4" onchange="onColorClicked(4)"></td>
						<td><button type="button" class="btn btn-light" onclick="shiftColor(-1)">►</button></td>
					</tr></table>

					<div class="dropdown" style="padding-top: 10px">
						<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Other colors</button>
						<div id="dropdownOtherColor" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
							
							<!-- FILLED PROGRAMATICALLY -->

						</div>
					</div>
				</div>
			</div>

			<div class="card" style="margin-top: 20px">
				<div class="card-header">Tile Settings</div>
				<div class="card-body">
					// TODO: implement settings action

					<form>
						<div class="form-row">
							<div class="col">
								<div class="form-group">
									<label for="pixelPaddingInput">Pixel Padding</label>
									<input type="number" class="form-control" id="pixelPaddingInput" value="0">
								</div>
							</div>
							<div class="col">
								<div class="form-group">
									<label for="tilePaddingInput">Tile Padding</label>
									<input type="number" class="form-control" id="tilePaddingInput" value="5">
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>



		<div style="margin-left: 330px">
			<div class="card">
				<div class="card-header">Tiles</div>
				<div class="card-body">
					<canvas id="myCanvas" width="700" height="4600"></canvas>
				</div>
			</div>


		</div>
	</div></div>

	<script>
		var currentBytes = null;

		const fileSelector = document.getElementById('fileSelector');
		fileSelector.addEventListener('change', (event) => {
			const fileList = event.target.files;
			var file = fileList[0];
			if (!file) {
				return;
			}
			var reader = new FileReader();
			reader.readAsArrayBuffer(file);

			reader.onload = function (evt) {
				var bytes = new Uint8Array(evt.target.result);
				currentBytes = bytes;
				paintTileFromBytesRow(bytes)				
			}
			reader.onerror = function (evt) {
				console.log("error reading file");
			}		

		});

		var lastPickedColorTime = 0;
		function onColorClicked(index) {
			const nowTime = new Date().getTime();
			const timeDiff = nowTime - lastPickedColorTime
			if (timeDiff < 500) {
				return;
			}
			const colorValue = document.getElementById("colorPicker" + index).value;
			colorPalette[index-1] = colorValue;
			paintTileFromBytesRow(currentBytes);
			lastPickedColorTime = nowTime;
		}

		function updateSelectedPalette(colors) {
			colors.forEach(function(color, i) {
				document.getElementById('colorPicker' + (i+1)).value = color;	
			});
		}
		updateSelectedPalette(colorPalette);

		function createElement(name, attributes) {
			var element = document.createElement(name);
			Object.keys(attributes).forEach(function(key, i) {
				element[key] = attributes[key];
			});
			return element;
		}

		Element.prototype.addChild = function(child) {
			this.appendChild(child);
			return this;
		};

		Element.prototype.addAttributes = function(attributes) {
			Object.keys(attributes).forEach(function(key, i) {
				this[key] = attributes[key];
			});
			return this;
		};

		var dropdown = document.getElementById('dropdownOtherColor');
		otherPalette.forEach(function(palette, i) {
			var dropItem = createElement('a', { 
				className : 'dropdown-item',
				onclick : function() { colorSelected(i) }
			})

			var tr = document.createElement("tr");
			tr.appendChild(createElement("td", { style : "width: 110px" })
				.addChild(createElement('h6', { 
				style : "margin-right: 20px; margin-top: .5rem;",
				innerHTML: palette.title
			})));
			palette.colors.forEach(function(color, i) {
				tr.appendChild(document.createElement("td").addChild(createElement('div', { 
					style : "background: " + color,
					className : "paletteSelector"
				})));
			});

			dropItem.appendChild(document.createElement("table").addChild(tr));
			dropdown.appendChild(dropItem);
		});

		function colorSelected(index) {
			colorPalette = otherPalette[index].colors;
			updateSelectedPalette(colorPalette);
			paintTileFromBytesRow(currentBytes);
		}

		function shiftColor(orientation) {
			var newColors = [];
			for (var i = 0; i < colorPalette.length; i++) {
				var index = (i + orientation) % (colorPalette.length);
				index = index < 0 ? colorPalette.length -1 : index;
				newColors[i] = colorPalette[index];
			}
			colorPalette = newColors;
			updateSelectedPalette(colorPalette);
			paintTileFromBytesRow(currentBytes);
		}

		// Example 
		const testHexBytes = ["ff", "ff", "99", "81", "c3", "e7", "ff", "ff", "ff", "99", "66", "7e", "bd", "db", "e7", "ff", "00", "42", "24", "18", "18", "24", "42", "00", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "c3", "bd", "bd", "bd", "bd", "c3", "ff", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00"];
		currentBytes = testHexBytes;
		paintTileFromBytesRow(testHexBytes);

	</script>

</body>
</html>