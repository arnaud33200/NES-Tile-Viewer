<!DOCTYPE html>
<html>
<head>
	<title>NES Tile Viewer</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="js/paintTile.js"></script>

	<script src="js/jquery-3.5.1.slim.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

</head>
<body>

	<div class="container"><div class="row">

		<div style="position: fixed; width: 300px">

			<h2 style="padding-bottom: 5px">
				<!-- <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/40/NES-Cartridge.jpg/250px-NES-Cartridge.jpg" style="width: 50px;"> -->
				NES Tile Viewer
			</h2>

			<div class="card shadow">
				<div class="card-header">File (*.chr, *.nes, ...)</div>
				<div class="card-body">

					<input type="file" id="fileSelector" style="width: 100%">
				</div>
			</div>

			<div class="card shadow" style="margin-top: 20px">
				<div class="card-header">Color Palette</div>
				<div class="card-body">

					<table><tr>
						<td><button type="button" class="btn btn-light" onclick="shiftColor(1)">◄</button></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker1" onchange="onColorClicked(1)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker2" onchange="onColorClicked(2)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker3" onchange="onColorClicked(3)"></td>
						<td><input class="colorPalettePicker" type="color" id="colorPicker4" onchange="onColorClicked(4)"></td>
						<td><button type="button" class="btn btn-light" onclick="shiftColor(-1)">►</button></td>
					</tr></table>

					<div class="dropdown" style="padding-top: 10px">
						<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Other colors</button>
						<div id="dropdownOtherColor" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
							
							<!-- FILLED PROGRAMATICALLY -->

						</div>
					</div>
				</div>
			</div>

			<div class="card shadow" style="margin-top: 20px">
				<div class="card-header">Tile Settings</div>
				<div class="card-body">
					<form>
						<div class="form-row">
							<div class="col"><div class="form-group">
								<label for="tilePerRowRange"><span id="tilePerRowLabel" class="badge badge-secondary">16</span> Tiles / Row</label>
								<input type="range" class="form-control-range" id="tilePerRowRange" value="16" min="1" max="24" onchange="updateTilePerRow(this.value)">
							</div></div>
							<div class="col"><div class="form-group">
								<label for="pixelPerTileRange"><span id="pixelPerTileLabel" class="badge badge-secondary">8</span> Pixels / Tile</label>
								<input type="range" class="form-control-range" id="pixelPerTileRange" value="8" min="1" max="16" onchange="updatePixelPerTile(this.value)">
							</div></div>
						</div>
						<div class="form-row">
							<div class="col">
								<div class="form-group">
									<label for="tilePaddingInput"><span id="tilePaddingRange" class="badge badge-secondary">5</span> Tile Padding</label>
									<input type="range" class="form-control-range" id="tilePaddingInput" value="5" min="0" max="20" onchange="updateTilePadding(this.value)">
								</div>
							</div>
							<div class="col">
								<div class="form-group">
									<label for="pixelPaddingInput"><span id="pixelPaddingRange" class="badge badge-secondary">0</span> Pixel Padding</label>
									<input type="range" class="form-control-range" id="pixelPaddingInput" value="0" min="0" max="10" onchange="updatePixelPadding(this.value)">
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>



		<div style="margin-left: 330px">
			<div class="card shadow">
				<div class="card-header">Tiles</div>
				<div class="card-body">
					<canvas id="myCanvas" width="700" height="4600"></canvas>
				</div>
			</div>


		</div>
	</div></div>

	<script>
		var currentBytes = null;

		const fileSelector = document.getElementById('fileSelector');
		fileSelector.addEventListener('change', (event) => {
			const fileList = event.target.files;
			var file = fileList[0];
			if (!file) {
				return;
			}
			var reader = new FileReader();
			reader.readAsArrayBuffer(file);

			reader.onload = function (evt) {
				var bytes = new Uint8Array(evt.target.result);
				currentBytes = bytes;
				paintTileFromBytesRow(bytes)				
			}
			reader.onerror = function (evt) {
				console.log("error reading file");
			}		

		});

		var lastPickedColorTime = 0;
		function onColorClicked(index) {
			const nowTime = new Date().getTime();
			const timeDiff = nowTime - lastPickedColorTime
			if (timeDiff < 500) {
				return;
			}
			const colorValue = document.getElementById("colorPicker" + index).value;
			colorPalette[index-1] = colorValue;
			paintTileFromBytesRow(currentBytes);
			lastPickedColorTime = nowTime;
		}

		function updateSelectedPalette(colors) {
			colors.forEach(function(color, i) {
				document.getElementById('colorPicker' + (i+1)).value = color;	
			});
		}
		updateSelectedPalette(colorPalette);

		function createElement(name, attributes) {
			var element = document.createElement(name);
			Object.keys(attributes).forEach(function(key, i) {
				element[key] = attributes[key];
			});
			return element;
		}

		Element.prototype.addChild = function(child) {
			this.appendChild(child);
			return this;
		};

		Element.prototype.addAttributes = function(attributes) {
			Object.keys(attributes).forEach(function(key, i) {
				this[key] = attributes[key];
			});
			return this;
		};

		var dropdown = document.getElementById('dropdownOtherColor');
		otherPalette.forEach(function(palette, i) {
			var dropItem = createElement('a', { 
				className : 'dropdown-item',
				onclick : function() { colorSelected(i) }
			})

			var tr = document.createElement("tr");
			tr.appendChild(createElement("td", { style : "width: 110px" })
				.addChild(createElement('h6', { 
					style : "margin-right: 20px; margin-top: .5rem;",
					innerHTML: palette.title
				})));
			palette.colors.forEach(function(color, i) {
				tr.appendChild(document.createElement("td").addChild(createElement('div', { 
					style : "background: " + color,
					className : "paletteSelector"
				})));
			});

			dropItem.appendChild(document.createElement("table").addChild(tr));
			dropdown.appendChild(dropItem);
		});

		function colorSelected(index) {
			colorPalette = otherPalette[index].colors;
			updateSelectedPalette(colorPalette);
			paintTileFromBytesRow(currentBytes);
		}

		function shiftColor(orientation) {
			var newColors = [];
			for (var i = 0; i < colorPalette.length; i++) {
				var index = (i + orientation) % (colorPalette.length);
				index = index < 0 ? colorPalette.length -1 : index;
				newColors[i] = colorPalette[index];
			}
			colorPalette = newColors;
			updateSelectedPalette(colorPalette);
			paintTileFromBytesRow(currentBytes);
		}

		function updateTilePerRow(value) {
			document.getElementById("tilePerRowLabel").innerHTML = value;
			tilePerRow = parseInt(value);
			paintTileFromBytesRow(currentBytes);
		}

		function updatePixelPerTile(value) {
			document.getElementById("pixelPerTileLabel").innerHTML = value;
			tileWidthPixelCount = parseInt(value);
			paintTileFromBytesRow(currentBytes);
		}

		function updateTilePadding(value) {
			document.getElementById("tilePaddingRange").innerHTML = value;
			tilepaddingSize = parseInt(value);
			paintTileFromBytesRow(currentBytes);
		}
		function updatePixelPadding(value) {
			document.getElementById("pixelPaddingRange").innerHTML = value;
			pixelpaddingSize = parseInt(value);
			paintTileFromBytesRow(currentBytes);
		}

		// Example 
		const testHexBytes = ["ff", "ff", "99", "81", "c3", "e7", "ff", "ff", "ff", "99", "66", "7e", "bd", "db", "e7", "ff", "00", "42", "24", "18", "18", "24", "42", "00", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "ff", "c3", "bd", "bd", "bd", "bd", "c3", "ff", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00"];
		currentBytes = testHexBytes;
		paintTileFromBytesRow(testHexBytes);

	</script>

</body>
</html>